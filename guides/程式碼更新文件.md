# Phone Auth API - ç¨‹å¼ç¢¼æ›´æ–°éƒ¨ç½²æ–‡ä»¶

## ğŸ“Œ æ›´æ–°æ‘˜è¦

ä¸»è¦ä¿®æ­£ `verify_otp` å‡½å¼çš„é©—è­‰é‚è¼¯ï¼Œå¾æ¨¡æ“¬å¯¦ä½œæ”¹ç‚ºçœŸå¯¦çš„ Firebase ID Token é©—è­‰ã€‚

### æ›´æ–°å…§å®¹
- âœ… ä¿®æ­£ `verify_otp` æ–¹æ³•ï¼Œå¯¦ä½œçœŸå¯¦ Firebase é©—è­‰
- âœ… æ”¹å–„ LOCKED ç‹€æ…‹éŒ¯èª¤è¨Šæ¯ï¼Œå¢åŠ  `retry_after` æ¬„ä½
- âœ… æ›´æ–°éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼Œæä¾›æ›´æ˜ç¢ºçš„éŒ¯èª¤è¨Šæ¯

### å—å½±éŸ¿çš„æª”æ¡ˆ
- ğŸ“ `phone_auth/firebase_service.py` - æ ¸å¿ƒé©—è­‰é‚è¼¯
- ğŸ“ `phone_auth/views.py` - API å›æ‡‰æ ¼å¼

---

## ğŸ”§ éœ€è¦æ›´æ–°çš„æª”æ¡ˆ

### 1ï¸âƒ£ firebase_service.py

**æª”æ¡ˆä½ç½®ï¼š** `phone_auth/firebase_service.py`

**éœ€è¦æ›´æ–°çš„å‡½å¼ï¼š** `verify_otp` æ–¹æ³•ï¼ˆç¬¬ 113-147 è¡Œï¼‰

#### åŸå§‹ç¨‹å¼ç¢¼ï¼ˆè«‹åˆªé™¤ï¼‰

```python
def verify_otp(self, verification_id: str, otp_code: str) -> dict:
    """
    é©—è­‰ OTP ä»£ç¢¼
    
    æ³¨æ„ï¼šæœ¬å°ˆæ¡ˆæ¡ç”¨ 6 ä½ OTPï¼ˆverification_id + otp_codeï¼‰ç‚ºå”¯ä¸€æµç¨‹ã€‚
    è‹¥åœ¨ä½ çš„æ¶æ§‹ä¸­éœ€èˆ‡ Firebase å‰ç«¯é©—è­‰æ•´åˆï¼Œè«‹ä¾å¯¦éš›éœ€æ±‚èª¿æ•´æ­¤æ–¹æ³•å¯¦ä½œã€‚
    
    Args:
        verification_id: Firebase è¿”å›çš„é©—è­‰ session ID
        otp_code: ä½¿ç”¨è€…è¼¸å…¥çš„é©—è­‰ç¢¼
    
    Returns:
        dict: {
            'success': bool,
            'phone_number': str (å¦‚æœæˆåŠŸ),
            'uid': str (Firebase user ID),
            'error': str (å¦‚æœå¤±æ•—)
        }
    """
    try:
        # é€™è£¡æä¾›ä¸€å€‹ç°¡åŒ–çš„å¯¦ä½œç¯„ä¾‹
        logger.info(f"é©—è­‰ OTPï¼šverification_id={verification_id}, code={otp_code}")
        
        # æ¨¡æ“¬é©—è­‰ï¼ˆå¯¦éš›æ‡‰å°æ¥ä½ çš„ OTP é©—è­‰æ©Ÿåˆ¶ï¼‰
        
        return {
            'success': True,
            'message': 'æ­¤ç‚ºæ¨¡æ“¬å¯¦ä½œï¼Œè«‹æ›¿æ›ç‚ºå¯¦éš›çš„ OTP é©—è­‰é‚è¼¯'
        }
    except Exception as e:
        logger.error(f"é©—è­‰ OTP æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
        return {
            'success': False,
            'error': str(e)
        }
```

#### æ–°ç¨‹å¼ç¢¼ï¼ˆè«‹æ›¿æ›ï¼‰

```python
def verify_otp(self, verification_id: str, otp_code: str) -> dict:
    """
    é©—è­‰ OTP ä»£ç¢¼ï¼ˆä½¿ç”¨ Firebase ID Tokenï¼‰
    
    å¯¦éš›æµç¨‹ï¼š
    1. å‰ç«¯ä½¿ç”¨ Firebase JS SDK å®Œæˆ phone authï¼ˆsignInWithPhoneNumber + confirmï¼‰
    2. æˆåŠŸå¾Œ Firebase è¿”å› idToken
    3. å‰ç«¯å°‡ idToken ä½œç‚º verification_id å‚³çµ¦å¾Œç«¯
    4. å¾Œç«¯é©—è­‰ idToken ä¸¦å–å¾—å·²é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼
    
    Args:
        verification_id: Firebase ID Tokenï¼ˆå‰ç«¯é©—è­‰æˆåŠŸå¾Œå–å¾—ï¼‰
        otp_code: ä½¿ç”¨è€…è¼¸å…¥çš„é©—è­‰ç¢¼ï¼ˆç”¨æ–¼å‰ç«¯é©—è­‰ï¼Œå¾Œç«¯åƒ…è¨˜éŒ„ï¼‰
    
    Returns:
        dict: {
            'success': bool,
            'phone_number': str (å¦‚æœæˆåŠŸ),
            'uid': str (Firebase user ID),
            'error': str (å¦‚æœå¤±æ•—)
        }
    """
    try:
        logger.info(f"é–‹å§‹é©—è­‰ Firebase ID Tokenï¼ŒOTP code: {otp_code}")
        
        # ä½¿ç”¨ Firebase Admin SDK é©—è­‰ ID Token
        decoded_token = auth.verify_id_token(verification_id)
        
        # å¾ token ä¸­å–å¾—å·²é©—è­‰çš„è³‡è¨Š
        uid = decoded_token.get('uid')
        phone_number = decoded_token.get('phone_number')
        
        if not phone_number:
            logger.warning("ID Token ä¸­æ²’æœ‰æ‰‹æ©Ÿè™Ÿç¢¼è³‡è¨Š")
            return {
                'success': False,
                'error': 'ID Token ä¸­æ²’æœ‰æ‰‹æ©Ÿè™Ÿç¢¼è³‡è¨Šï¼Œè«‹ç¢ºèªå‰ç«¯ä½¿ç”¨ Phone Auth æ–¹å¼ç™»å…¥'
            }
        
        logger.info(f"é©—è­‰æˆåŠŸï¼šuid={uid}, phone={phone_number}")
        
        return {
            'success': True,
            'phone_number': phone_number,
            'uid': uid,
            'message': 'æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰æˆåŠŸ'
        }
        
    except auth.InvalidIdTokenError:
        logger.error("ç„¡æ•ˆçš„ ID Token")
        return {
            'success': False,
            'error': 'é©—è­‰ç¢¼å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™¼é€'
        }
    except auth.ExpiredIdTokenError:
        logger.error("ID Token å·²éæœŸ")
        return {
            'success': False,
            'error': 'é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç™¼é€'
        }
    except Exception as e:
        logger.error(f"é©—è­‰ OTP æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š{str(e)}")
        return {
            'success': False,
            'error': f'é©—è­‰å¤±æ•—ï¼š{str(e)}'
        }
```

---

### 2ï¸âƒ£ views.py

**æª”æ¡ˆä½ç½®ï¼š** `phone_auth/views.py`

**éœ€è¦æ›´æ–°çš„ä½ç½®ï¼š** å…± 3 è™•

#### æ›´æ–° 1ï¼šverify_otp å‡½å¼ - LOCKED ç‹€æ…‹æª¢æŸ¥ï¼ˆç¬¬ 223-230 è¡Œï¼‰

**åŸå§‹ç¨‹å¼ç¢¼ï¼š**
```python
# æª¢æŸ¥æ˜¯å¦å·²é–å®š
if user.verification_status == CustomUser.VerificationStatus.LOCKED:
    logger.warning(f"ä½¿ç”¨è€… {user.username} å·²è¢«é–å®š")
    return Response(
        {
            'status': 'LOCKED',
            'message': 'é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹é‡æ–°ç™¼é€é©—è­‰ç¢¼'
        },
        status=status.HTTP_403_FORBIDDEN
    )
```

**æ–°ç¨‹å¼ç¢¼ï¼š**
```python
# æª¢æŸ¥æ˜¯å¦å·²é–å®š
if user.verification_status == CustomUser.VerificationStatus.LOCKED:
    logger.warning(f"ä½¿ç”¨è€… {user.username} å·²è¢«é–å®š")
    return Response(
        {
            'status': 'LOCKED',
            'message': 'é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹ 60 ç§’å¾Œé‡æ–°ç™¼é€é©—è­‰ç¢¼',
            'retry_after': 60
        },
        status=status.HTTP_403_FORBIDDEN
    )
```

#### æ›´æ–° 2ï¼šverify_otp å‡½å¼ - é©—è­‰æˆåŠŸè™•ç†ï¼ˆç¬¬ 236-264 è¡Œï¼‰

**åŸå§‹ç¨‹å¼ç¢¼ï¼š**
```python
result = firebase_service.verify_otp(verification_id, otp_code)

if result.get('success'):
    # æ¨¡æ“¬é©—è­‰æˆåŠŸï¼ˆå¯¦éš›æ‡‰å¾ result å–å¾—å·²é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰
    verified_phone = user.phone_number
    
    user.phone_verified = True
    user.verification_status = CustomUser.VerificationStatus.VERIFIED
    user.otp_attempts = 0
    user.save()
    
    # è¨˜éŒ„æ—¥èªŒ
    OTPVerificationLog.objects.create(
        user=user,
        phone_number=verified_phone or '',
        action='VERIFY_SUCCESS',
        success=True
    )
    
    logger.info(f"æ‰‹æ©Ÿé©—è­‰æˆåŠŸï¼šuser={user.username}, phone={verified_phone}")
    
    return Response(
        {
            'status': 'VERIFIED',
            'phone_number': verified_phone,
            'message': 'æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰æˆåŠŸ'
        },
        status=status.HTTP_200_OK
    )
```

**æ–°ç¨‹å¼ç¢¼ï¼š**
```python
result = firebase_service.verify_otp(verification_id, otp_code)

if result.get('success'):
    # å¾ Firebase é©—è­‰çµæœå–å¾—å·²é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼
    verified_phone = result.get('phone_number')
    firebase_uid = result.get('uid')
    
    # æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦èˆ‡ä½¿ç”¨è€…ç•¶å‰ç¶å®šçš„è™Ÿç¢¼ä¸€è‡´
    if user.phone_number and user.phone_number != verified_phone:
        logger.warning(f"æ‰‹æ©Ÿè™Ÿç¢¼ä¸ç¬¦ï¼šuser.phone={user.phone_number}, verified={verified_phone}")
        return Response(
            {
                'error': 'PHONE_MISMATCH',
                'message': 'é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡æ‚¨çš„å¸³è™Ÿä¸ç¬¦ï¼Œè«‹ç¢ºèª'
            },
            status=status.HTTP_400_BAD_REQUEST
        )
    
    # æ›´æ–°ä½¿ç”¨è€…è³‡æ–™
    user.phone_number = verified_phone
    user.phone_verified = True
    user.verification_status = CustomUser.VerificationStatus.VERIFIED
    user.otp_attempts = 0
    user.save()
    
    # è¨˜éŒ„æ—¥èªŒ
    OTPVerificationLog.objects.create(
        user=user,
        phone_number=verified_phone or '',
        action='VERIFY_SUCCESS',
        success=True
    )
    
    logger.info(f"æ‰‹æ©Ÿé©—è­‰æˆåŠŸï¼šuser={user.username}, phone={verified_phone}, uid={firebase_uid}")
    
    return Response(
        {
            'status': 'VERIFIED',
            'phone_number': verified_phone,
            'message': 'æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰æˆåŠŸ'
        },
        status=status.HTTP_200_OK
    )
```

#### æ›´æ–° 3ï¼šverify_otp å‡½å¼ - é©—è­‰å¤±æ•—å¾Œçš„ LOCKED å›æ‡‰ï¼ˆç¬¬ 278-285 è¡Œï¼‰

**åŸå§‹ç¨‹å¼ç¢¼ï¼š**
```python
if user.verification_status == CustomUser.VerificationStatus.LOCKED:
    return Response(
        {
            'status': 'LOCKED',
            'message': 'é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹é‡æ–°ç™¼é€é©—è­‰ç¢¼'
        },
        status=status.HTTP_403_FORBIDDEN
    )
```

**æ–°ç¨‹å¼ç¢¼ï¼š**
```python
if user.verification_status == CustomUser.VerificationStatus.LOCKED:
    return Response(
        {
            'status': 'LOCKED',
            'message': 'é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹ 60 ç§’å¾Œé‡æ–°ç™¼é€é©—è­‰ç¢¼',
            'retry_after': 60
        },
        status=status.HTTP_403_FORBIDDEN
    )
```

---

### ğŸ“Š æ›´æ–°å‰å¾Œ API å›æ‡‰è®ŠåŒ–

**LOCKED ç‹€æ…‹å›æ‡‰ï¼ˆæ–°å¢ retry_afterï¼‰ï¼š**

```diff
{
  "status": "LOCKED",
- "message": "é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹é‡æ–°ç™¼é€é©—è­‰ç¢¼"
+ "message": "é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹ 60 ç§’å¾Œé‡æ–°ç™¼é€é©—è­‰ç¢¼",
+ "retry_after": 60
}
```

**é©—è­‰å¤±æ•—å›æ‡‰ï¼ˆæ–°å¢è©³ç´°éŒ¯èª¤ï¼‰ï¼š**

```diff
{
  "status": "INVALID_OTP",
- "error": "é©—è­‰å¤±æ•—"
+ "error": "é©—è­‰ç¢¼å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™¼é€"
}
```
