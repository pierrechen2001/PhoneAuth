# Phone Auth API å®Œæ•´èªªæ˜ - Firebase å‰å¾Œç«¯é©—è­‰æµç¨‹

## ğŸ“Œ æ›´æ–°æ‘˜è¦

æˆ‘å·²ç¶“å®Œæˆ Phone Auth API çš„ä¿®æ­£ï¼Œä¸»è¦è§£æ±º Kevin æåˆ°çš„å¹¾å€‹å•é¡Œï¼š

âœ… **verify-otp ä¸å†æ¥å—ä»»æ„è¼¸å…¥**ï¼ˆæ”¹ç”¨çœŸå¯¦ Firebase é©—è­‰ï¼‰  
âœ… **LOCKED ç‹€æ…‹åŠ å…¥ retry_after æ¬„ä½**  
âœ… **é‡æ¸…å‰å¾Œç«¯é©—è­‰è·è²¬**

---

## ğŸ” Firebase é©—è­‰æ©Ÿåˆ¶èªªæ˜

### æ ¸å¿ƒæ¦‚å¿µï¼šå‰ç«¯é©—è­‰ OTPï¼Œå¾Œç«¯é©—è­‰æ†‘è­‰

Firebase Phone Auth ä½¿ç”¨**é›™é‡é©—è­‰æ©Ÿåˆ¶**ï¼Œé€™ä¸æ˜¯é‡è¤‡é©—è­‰ï¼Œè€Œæ˜¯åˆ†åˆ¥é©—è­‰ä¸åŒæ±è¥¿ï¼š

```
å‰ç«¯é©—è­‰ï¼šé©—è­‰ã€Œä½¿ç”¨è€…è¼¸å…¥çš„ OTP æ˜¯å¦æ­£ç¢ºã€
         â†“
       å–å¾— idTokenï¼ˆFirebase ç°½ç™¼çš„æ†‘è­‰ï¼‰
         â†“
å¾Œç«¯é©—è­‰ï¼šé©—è­‰ã€ŒidToken æ˜¯å¦ç”± Firebase çœŸå¯¦ç°½ç™¼ã€ï¼ˆé˜²å½é€ ï¼‰
         â†“
       ç¶å®šæ‰‹æ©Ÿè™Ÿç¢¼åˆ°ä½¿ç”¨è€…å¸³è™Ÿ
```

---

## ğŸ”„ å®Œæ•´é©—è­‰æµç¨‹

### åªæœ‰å‰ç«¯å¯ä»¥ç™¼é€ OTP ï½

```
âŒ å¾Œç«¯ç„¡æ³•ç™¼é€ OTP
   - Firebase Admin SDKï¼ˆå¾Œç«¯ï¼‰åªèƒ½é©—è­‰ï¼Œä¸èƒ½ç™¼é€
   - send-otp API ä¸æœƒçœŸçš„ç™¼é€ SMS

âœ… å‰ç«¯æ‰èƒ½ç™¼é€ OTP
   - ä½¿ç”¨ Firebase JS SDK çš„ signInWithPhoneNumber
   - Firebase è‡ªå‹•ç™¼é€ SMS åˆ°ä½¿ç”¨è€…æ‰‹æ©Ÿ
```

---

### æ­¥é©Ÿ 1ï¼šå‰ç«¯ç™¼é€ OTPï¼ˆFirebase JS SDKï¼‰
> OTP åªèƒ½ç”±å‰ç«¯ç™¼é€ï¼Œå¾Œé¢æœƒå†èªªæ˜æ˜¯å¦éœ€è¦ call send_otp API

```javascript
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from 'firebase/auth';

const auth = getAuth();

// 1.1 è¨­å®š reCAPTCHA
window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
  'size': 'invisible'
});

// 1.2 ç™¼é€ OTPï¼ˆFirebase è‡ªå‹•ç™¼é€ SMSï¼‰
const phoneNumber = '+886987654321';
const appVerifier = window.recaptchaVerifier;

const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
// â†‘ æ­¤æ™‚ SMS å·²ç™¼é€ï¼Œä½¿ç”¨è€…æœƒæ”¶åˆ°é©—è­‰ç¢¼

// å„²å­˜ confirmationResultï¼Œç­‰å¾…ä½¿ç”¨è€…è¼¸å…¥ OTP
window.confirmationResult = confirmationResult;
```

**é‡é»ï¼š**
- âœ… **Firebase JS SDK æ‰èƒ½ç™¼é€ SMS**ï¼ˆé€™æ˜¯å”¯ä¸€æ–¹å¼ï¼‰
- âœ… è¿”å› `confirmationResult`ï¼ˆåŒ…å« verificationIdï¼‰
- âš ï¸  å¾Œç«¯ `send-otp` API æ˜¯å¯é¸çš„ï¼ˆè¦‹ä¸‹æ–¹èªªæ˜ï¼‰

---

### æ­¥é©Ÿ 2ï¼šå‰ç«¯é©—è­‰ OTPï¼ˆå¿…é ˆï¼ï¼‰

```javascript
// ä½¿ç”¨è€…è¼¸å…¥ OTP å¾Œ
const otpCode = '123456'; // ä½¿ç”¨è€…è¼¸å…¥çš„ 6 ä½æ•¸é©—è­‰ç¢¼

try {
  // 2.1 å‰ç«¯é©—è­‰ OTPï¼ˆé©—è­‰ç¢¼æ˜¯å¦æ­£ç¢ºï¼‰
  const result = await window.confirmationResult.confirm(otpCode);
  
  // 2.2 é©—è­‰æˆåŠŸï¼å–å¾— idToken
  const idToken = await result.user.getIdToken();
  
  console.log('å‰ç«¯é©—è­‰æˆåŠŸï¼Œå–å¾— idToken');
  
  // 2.3 å‘¼å«å¾Œç«¯ API
  await callBackendVerifyOTP(idToken, otpCode);
  
} catch (error) {
  // å‰ç«¯é©—è­‰å¤±æ•—
  if (error.code === 'auth/invalid-verification-code') {
    alert('é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥');
  } else if (error.code === 'auth/code-expired') {
    alert('é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç™¼é€');
  } else {
    alert('é©—è­‰å¤±æ•—ï¼š' + error.message);
  }
  // å¦‚æœå‰ç«¯é©—è­‰å¤±æ•—ï¼Œä¸éœ€è¦å‘¼å«å¾Œç«¯
}
```

**é‡é»ï¼š**
- âœ… `confirm(otpCode)` é©—è­‰ OTP æ˜¯å¦æ­£ç¢º
- âœ… æˆåŠŸå¾Œå–å¾— `idToken`ï¼ˆFirebase ç°½ç™¼çš„æ†‘è­‰ï¼‰
- âš ï¸  é€™ä¸€æ­¥**ä¸èƒ½çœç•¥**ï¼æ²’æœ‰ confirm å°±æ²’æœ‰ idToken

---

### æ­¥é©Ÿ 3ï¼šå‘¼å«å¾Œç«¯ verify-otp API

```javascript
async function callBackendVerifyOTP(idToken, otpCode) {
  try {
    const response = await fetch('https://ai.akira-dialog.com/auth/phone/verify-otp/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // Session Authentication æœƒè‡ªå‹•å¸¶ cookie
      },
      credentials: 'include', // é‡è¦ï¼šå¸¶ä¸Š session cookie
      body: JSON.stringify({
        verification_id: idToken,  // â† ä½¿ç”¨ idTokenï¼Œä¸æ˜¯ verificationIdï¼
        otp_code: otpCode          // â† å¾Œç«¯åƒ…ç”¨æ–¼è¨˜éŒ„ï¼Œä¸ç”¨æ–¼é©—è­‰
      })
    });
    
    const data = await response.json();
    
    if (response.ok) {
      // æˆåŠŸï¼
      console.log('æ‰‹æ©Ÿè™Ÿç¢¼ç¶å®šæˆåŠŸï¼š', data.phone_number);
      alert(`é©—è­‰æˆåŠŸï¼æ‰‹æ©Ÿè™Ÿç¢¼ï¼š${data.phone_number}`);
    } else {
      // å¤±æ•—
      console.error('å¾Œç«¯é©—è­‰å¤±æ•—ï¼š', data);
      handleBackendError(data);
    }
    
  } catch (error) {
    console.error('API å‘¼å«éŒ¯èª¤ï¼š', error);
    alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}
```

---

## ğŸ“¥ API è¦æ ¼ï¼šPOST /auth/phone/verify-otp/

### Requestï¼ˆå‰ç«¯éœ€è¦å‚³å…¥ï¼‰

```json
{
  "verification_id": "eyJhbGciOiJSUzI1N...",  // Firebase idToken
  "otp_code": "123456"                        // ä½¿ç”¨è€…è¼¸å…¥çš„é©—è­‰ç¢¼
}
```

**æ¬„ä½èªªæ˜ï¼š**

| æ¬„ä½ | é¡å‹ | èªªæ˜ | ä¾†æº |
|------|------|------|------|
| `verification_id` | string | Firebase ID Tokenï¼ˆJWTï¼‰ | `result.user.getIdToken()` |
| `otp_code` | string | 6 ä½æ•¸é©—è­‰ç¢¼ | ä½¿ç”¨è€…è¼¸å…¥ |

**é‡é»ï¼š**
- âš ï¸  `verification_id` æ˜¯ **idToken**ï¼Œä¸æ˜¯ `confirmationResult.verificationId`
- âš ï¸  `otp_code` å¾Œç«¯åƒ…ç”¨æ–¼è¨˜éŒ„ï¼Œå¯¦éš›é©—è­‰åœ¨å‰ç«¯å®Œæˆ

---

### Responseï¼ˆå‰ç«¯æœƒæ”¶åˆ°ï¼‰

#### âœ… æˆåŠŸå›æ‡‰ï¼ˆ200 OKï¼‰

```json
{
  "status": "VERIFIED",
  "phone_number": "+886987654321",
  "message": "æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰æˆåŠŸ"
}
```

#### âŒ éŒ¯èª¤å›æ‡‰ 1ï¼šé©—è­‰ç¢¼éŒ¯èª¤ï¼ˆ400 Bad Requestï¼‰

```json
{
  "status": "INVALID_OTP",
  "remaining_attempts": 2,
  "message": "é©—è­‰ç¢¼éŒ¯èª¤ï¼Œæ‚¨é‚„æœ‰ 2 æ¬¡æ©Ÿæœƒ"
}
```

#### âŒ éŒ¯èª¤å›æ‡‰ 2ï¼šå·²é–å®šï¼ˆ403 Forbiddenï¼‰

```json
{
  "status": "LOCKED",
  "message": "é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹ 60 ç§’å¾Œé‡æ–°ç™¼é€é©—è­‰ç¢¼",
  "retry_after": 60
}
```

#### âŒ éŒ¯èª¤å›æ‡‰ 3ï¼šToken ç„¡æ•ˆï¼ˆ400 Bad Requestï¼‰

```json
{
  "error": "é©—è­‰ç¢¼å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™¼é€"
}
```

#### âŒ éŒ¯èª¤å›æ‡‰ 4ï¼šæ‰‹æ©Ÿè™Ÿç¢¼ä¸ç¬¦ï¼ˆ400 Bad Requestï¼‰

```json
{
  "error": "PHONE_MISMATCH",
  "message": "é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡æ‚¨çš„å¸³è™Ÿä¸ç¬¦ï¼Œè«‹ç¢ºèª"
}
```

---

## ğŸ”§ å¾Œç«¯å¯¦ä½œï¼šverify_otp è§£é‡‹

### ä¿®æ”¹çš„é‚è¼¯ï¼ˆfirebase_service.pyï¼‰

```python
def verify_otp(self, verification_id: str, otp_code: str) -> dict:
    """
    é©—è­‰ Firebase ID Token
    
    Args:
        verification_id: Firebase ID Tokenï¼ˆå‰ç«¯é©—è­‰æˆåŠŸå¾Œå–å¾—ï¼‰
        otp_code: ä½¿ç”¨è€…è¼¸å…¥çš„é©—è­‰ç¢¼ï¼ˆç”¨æ–¼è¨˜éŒ„ï¼‰
    
    Returns:
        dict: {'success': bool, 'phone_number': str, 'uid': str, 'error': str}
    """
    try:
        # 1. ä½¿ç”¨ Firebase Admin SDK é©—è­‰ ID Token
        decoded_token = auth.verify_id_token(verification_id)
        
        # 2. å¾ token ä¸­å–å¾—å·²é©—è­‰çš„è³‡è¨Š
        uid = decoded_token.get('uid')               # Firebase User ID
        phone_number = decoded_token.get('phone_number')  # å·²é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼
        
        # 3. æª¢æŸ¥ token ä¸­æ˜¯å¦åŒ…å«æ‰‹æ©Ÿè™Ÿç¢¼
        if not phone_number:
            return {
                'success': False,
                'error': 'ID Token ä¸­æ²’æœ‰æ‰‹æ©Ÿè™Ÿç¢¼è³‡è¨Šï¼Œè«‹ç¢ºèªå‰ç«¯ä½¿ç”¨ Phone Auth æ–¹å¼ç™»å…¥'
            }
        
        # 4. é©—è­‰æˆåŠŸ
        return {
            'success': True,
            'phone_number': phone_number,
            'uid': uid,
            'message': 'æ‰‹æ©Ÿè™Ÿç¢¼é©—è­‰æˆåŠŸ'
        }
        
    except auth.InvalidIdTokenError:
        return {'success': False, 'error': 'é©—è­‰ç¢¼å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™¼é€'}
    except auth.ExpiredIdTokenError:
        return {'success': False, 'error': 'é©—è­‰ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç™¼é€'}
    except Exception as e:
        return {'success': False, 'error': f'é©—è­‰å¤±æ•—ï¼š{str(e)}'}
```

### å¾Œç«¯é©—è­‰æ­¥é©Ÿ

```
1ï¸âƒ£ é©—è­‰ idToken æ˜¯å¦ç”± Firebase ç°½ç™¼ï¼ˆé˜²å½é€ ï¼‰
   â†“
2ï¸âƒ£ é©—è­‰ idToken æ˜¯å¦éæœŸ
   â†“
3ï¸âƒ£ å¾ idToken ä¸­æå–å·²é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼
   â†“
4ï¸âƒ£ æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦èˆ‡ä½¿ç”¨è€…å¸³è™Ÿä¸€è‡´
   â†“
5ï¸âƒ£ æ›´æ–°è³‡æ–™åº«ï¼šç¶å®šæ‰‹æ©Ÿè™Ÿç¢¼åˆ°ä½¿ç”¨è€…
   â†“
6ï¸âƒ£ è¨˜éŒ„æ—¥èªŒ
```

---

## ğŸ¯ å‰ç«¯è™•ç†éŒ¯èª¤å›æ‡‰

```javascript
function handleBackendError(data) {
  switch (data.status) {
    case 'INVALID_OTP':
      alert(`é©—è­‰å¤±æ•—ï¼Œæ‚¨é‚„æœ‰ ${data.remaining_attempts} æ¬¡æ©Ÿæœƒ`);
      break;
      
    case 'LOCKED':
      alert(`é©—è­‰å¤±æ•—æ¬¡æ•¸éå¤šï¼Œè«‹ç­‰å¾… ${data.retry_after} ç§’å¾Œé‡æ–°ç™¼é€`);
      // å¯ä»¥é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚
      showCountdown(data.retry_after);
      break;
      
    default:
      if (data.error === 'PHONE_MISMATCH') {
        alert('é©—è­‰çš„æ‰‹æ©Ÿè™Ÿç¢¼èˆ‡æ‚¨çš„å¸³è™Ÿä¸ç¬¦');
      } else {
        alert(`é©—è­‰å¤±æ•—ï¼š${data.message || data.error}`);
      }
  }
}
```

---

## ğŸ“ send-otp API èªªæ˜

**send-otp API ä¸æœƒç™¼é€ SMSï¼**

```python
# phone_auth/views.py - send_otp å‡½å¼
def send_otp(request):
    # 1. é©—è­‰æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ âœ…
    # 2. æª¢æŸ¥ Rate Limitingï¼ˆ60ç§’å…§ä¸å¯é‡è¤‡ï¼‰ âœ…
    # 3. æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å·²è¢«å…¶ä»–ä½¿ç”¨è€…ç¶å®š âœ…
    # 4. æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹ï¼ˆphone_number, verification_statusï¼‰ âœ…
    # 5. è¨˜éŒ„æ—¥èªŒ âœ…
    # 6. ç™¼é€ SMS âŒ <- ä¸æœƒåšé€™å€‹ï¼
```

---

### æ˜¯å¦éœ€è¦å‘¼å« send-otp APIï¼Ÿ

#### æ–¹æ¡ˆ Aï¼šä¸å‘¼å« send-otp

**é©åˆï¼š** è¿½æ±‚ç°¡æ½”ã€å¿«é€Ÿé–‹ç™¼

```javascript
// ç›´æ¥ç”¨ Firebase ç™¼é€
const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
const result = await confirmationResult.confirm(otp);
const idToken = await result.user.getIdToken();

// ç›´æ¥å‘¼å« verify-otp
await fetch('/verify-otp/', {
  body: JSON.stringify({ verification_id: idToken, otp_code: otp })
});
```

**å„ªé»ï¼š**
- âœ… æµç¨‹ç°¡å–®ï¼ˆå°‘ä¸€æ¬¡ API å‘¼å«ï¼‰
- âœ… æ¸›å°‘å¾Œç«¯è² æ“”
- âœ… Firebase æœ¬èº«æœ‰ Rate Limiting

**ç¼ºé»ï¼š**
- âŒ å¾Œç«¯æ²’è¨˜éŒ„ç™¼é€ç‹€æ…‹
- âŒ è¦åˆ° verify æ™‚æ‰çŸ¥é“æ‰‹æ©Ÿè™Ÿç¢¼å·²è¢«ç¶å®š

---

#### æ–¹æ¡ˆ Bï¼šå‘¼å« send-otpï¼ˆå®Œæ•´ï¼‰

**é©åˆï¼š** éœ€è¦å®Œæ•´è¨˜éŒ„ã€æ›´å¥½çš„ UX

```javascript
// 1. å…ˆå‘¼å«å¾Œç«¯ï¼ˆæª¢æŸ¥ + è¨˜éŒ„ï¼‰
const response = await fetch('/send-otp/', {
  body: JSON.stringify({
    country_code: '+886',
    phone_number: '987654321'
  })
});

if (!response.ok) {
  const error = await response.json();
  if (error.error === 'PHONE_ALREADY_BOUND') {
    alert('æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å·²è¢«å…¶ä»–å¸³è™Ÿç¶å®š');
    return; // æå‰çµæŸï¼Œä¸ç™¼é€ OTP
  }
}

// 2. å¾Œç«¯æª¢æŸ¥é€šéï¼Œæ‰ç”¨ Firebase ç™¼é€
const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);

// 3-4. é©—è­‰æµç¨‹...
```

**å„ªé»ï¼š**
- âœ… æå‰æª¢æŸ¥æ‰‹æ©Ÿè™Ÿç¢¼æ˜¯å¦å·²è¢«ç¶å®šï¼ˆUX æ›´å¥½ï¼‰
- âœ… å¾Œç«¯çµ±ä¸€ç®¡ç† Rate Limiting
- âœ… å®Œæ•´çš„æ—¥èªŒè¨˜éŒ„ï¼ˆæ–¹ä¾¿è¿½è¹¤å’Œé™¤éŒ¯ï¼‰
- âœ… è¨˜éŒ„ä½¿ç”¨è€…ç‹€æ…‹è®ŠåŒ–

**ç¼ºé»ï¼š**
- âŒ å¤šä¸€æ¬¡ API å‘¼å«
- âŒ æµç¨‹ç¨å¾®è¤‡é›œ

---

## ğŸ’¡ å¯èƒ½æœƒé‡åˆ°çš„å•é¡Œ

### Q1: ç‚ºä»€éº¼è¦é©—è­‰å…©æ¬¡ï¼Ÿ

**A:** ä¸æ˜¯é‡è¤‡é©—è­‰ï¼Œè€Œæ˜¯é©—è­‰ä¸åŒæ±è¥¿ï¼š
- **å‰ç«¯ï¼š** é©—è­‰ä½¿ç”¨è€…è¼¸å…¥çš„ OTP æ˜¯å¦æ­£ç¢º
- **å¾Œç«¯ï¼š** é©—è­‰å‰ç«¯æ‹¿åˆ°çš„æ†‘è­‰æ˜¯å¦çœŸå¯¦ï¼ˆé˜²æ­¢å½é€ ï¼‰

é€™æ˜¯å®‰å…¨æ©Ÿåˆ¶ï¼Œç¼ºä¸€ä¸å¯ã€‚

---

### Q2: å¯ä»¥æ‹¿æ‰å‰ç«¯é©—è­‰å—ï¼Ÿ

**A:** âŒ ä¸è¡Œï¼
- æ²’æœ‰å‰ç«¯ `confirm(otp)` å°±æ‹¿ä¸åˆ° idToken
- å¾Œç«¯éœ€è¦ idToken æ‰èƒ½é©—è­‰
- é€™æ˜¯ Firebase æ¶æ§‹è¦æ±‚

---

### Q3: verification_id åˆ°åº•æ˜¯ä»€éº¼ï¼Ÿ

**A:** æœ‰å…©å€‹å®¹æ˜“æ··æ·†çš„æ±è¥¿ï¼š

| åç¨± | æ˜¯ä»€éº¼ | å¾å“ªä¾† | çµ¦èª°ç”¨ |
|------|--------|--------|--------|
| `verificationId` | Firebase çš„ session ID | `confirmationResult.verificationId` | å‰ç«¯å…§éƒ¨ä½¿ç”¨ |
| `idToken` | Firebase ç°½ç™¼çš„æ†‘è­‰ï¼ˆJWTï¼‰ | `result.user.getIdToken()` | å‚³çµ¦å¾Œç«¯ |

**å¾Œç«¯ API éœ€è¦çš„æ˜¯ `idToken`ï¼Œä¸æ˜¯ `verificationId`ï¼**

---

### Q4: otp_code åœ¨å¾Œç«¯æœ‰ç”¨å—ï¼Ÿ

**A:** åƒ…ç”¨æ–¼è¨˜éŒ„ï¼Œä¸ç”¨æ–¼é©—è­‰ã€‚
- çœŸæ­£çš„é©—è­‰åœ¨å‰ç«¯å®Œæˆï¼ˆ`confirm(otp)`ï¼‰
- å¾Œç«¯åªé©—è­‰ idToken çš„çœŸå¯¦æ€§
- å¾Œç«¯çš„ `otp_code` åƒæ•¸ä¸»è¦æ˜¯è¨˜éŒ„åˆ° log ä¸­

---

### Q5: å¦‚æœå‰ç«¯é©—è­‰å¤±æ•—ï¼Œé‚„è¦å‘¼å«å¾Œç«¯å—ï¼Ÿ

**A:** âŒ ä¸éœ€è¦ï¼
```javascript
try {
  const result = await confirmationResult.confirm(otp);
  const idToken = await result.user.getIdToken();
  // å‰ç«¯é©—è­‰æˆåŠŸï¼Œæ‰å‘¼å«å¾Œç«¯
  await callBackendAPI(idToken, otp);
} catch (error) {
  // å‰ç«¯é©—è­‰å¤±æ•—ï¼Œç›´æ¥é¡¯ç¤ºéŒ¯èª¤ï¼Œä¸å‘¼å«å¾Œç«¯
  alert('é©—è­‰ç¢¼éŒ¯èª¤');
}
```

---

## ğŸ§ª æ¸¬è©¦æ–¹å¼èˆ‡è¨­å®š

### æ–¹å¼ 1ï¼šä½¿ç”¨ Firebase æ¸¬è©¦æ‰‹æ©Ÿè™Ÿç¢¼

**ä¸éœ€è¦çœŸçš„ç™¼é€ SMSï¼Œå¯ä»¥ç„¡é™æ¬¡æ¸¬è©¦ï¼**

#### æ­¥é©Ÿ 1ï¼šåœ¨ Firebase Console è¨­å®šæ¸¬è©¦è™Ÿç¢¼

**æ“ä½œæ­¥é©Ÿï¼š**

1. å‰å¾€ [Firebase Console](https://console.firebase.google.com/)
2. é¸æ“‡å°ˆæ¡ˆ
3. å·¦å´é¸å–®ï¼š**Authentication** â†’ **Sign-in method**
4. æ‰¾åˆ° **Phone** â†’ é»æ“Šç·¨è¼¯
5. å±•é–‹ **Phone numbers for testing**
6. åŠ å…¥æ¸¬è©¦è™Ÿç¢¼ç™½åå–®å’Œå›ºå®šé©—è­‰ç¢¼ï¼š

```
æ¸¬è©¦è™Ÿç¢¼ 1ï¼š+886987654321ï¼Œé©—è­‰ç¢¼ï¼š123456
æ¸¬è©¦è™Ÿç¢¼ 2ï¼š+886987654322ï¼Œé©—è­‰ç¢¼ï¼š123456
æ¸¬è©¦è™Ÿç¢¼ 3ï¼š+886987654323ï¼Œé©—è­‰ç¢¼ï¼š123456
ï¼ˆå¯åŠ å…¥æ›´å¤š...ï¼‰
```

7. å„²å­˜

#### æ­¥é©Ÿ 2ï¼šå‰ç«¯æ¸¬è©¦

```javascript
// 1. ç™¼é€ OTPï¼ˆä¸æœƒçœŸçš„ç™¼é€ SMSï¼‰
const confirmationResult = await signInWithPhoneNumber(auth, '+886987654321', appVerifier);

// 2. ä½¿ç”¨ä½ è¨­å®šçš„å›ºå®šé©—è­‰ç¢¼
const result = await confirmationResult.confirm('123456');  // â† å›ºå®šçš„æ¸¬è©¦é©—è­‰ç¢¼

// 3. å–å¾— idToken
const idToken = await result.user.getIdToken();

// 4. å‘¼å«å¾Œç«¯
const response = await fetch('/verify-otp/', {
  body: JSON.stringify({ verification_id: idToken, otp_code: '123456' })
});
```

**å„ªé»ï¼š**
- âœ… ä¸æ¶ˆè€— SMS é¡åº¦
- âœ… å¯ä»¥ç„¡é™æ¬¡æ¸¬è©¦
- âœ… æ¸¬è©¦ç¢¼å›ºå®šï¼Œæ–¹ä¾¿è‡ªå‹•åŒ–æ¸¬è©¦

**æ³¨æ„ï¼š**
- âš ï¸  æ¸¬è©¦è™Ÿç¢¼åªèƒ½åœ¨é–‹ç™¼ç’°å¢ƒä½¿ç”¨
- âš ï¸  éƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒå‰è¦ç§»é™¤æ¸¬è©¦è™Ÿç¢¼

---

### æ–¹å¼ 2ï¼šä½¿ç”¨çœŸå¯¦æ‰‹æ©Ÿè™Ÿç¢¼

å¦‚æœè¦æ¸¬è©¦çœŸå¯¦çš„ SMS ç™¼é€ï¼š

```javascript
// ä½¿ç”¨çœŸå¯¦æ‰‹æ©Ÿè™Ÿç¢¼
const confirmationResult = await signInWithPhoneNumber(auth, '+886912345678', appVerifier);

// ç­‰å¾…æ”¶åˆ° SMSï¼Œè¼¸å…¥çœŸå¯¦çš„é©—è­‰ç¢¼
const result = await confirmationResult.confirm(realOtpCode);
```

**æ³¨æ„ï¼š**
- âš ï¸  æœƒæ¶ˆè€— Firebase SMS é¡åº¦
- âš ï¸  æœ‰ç™¼é€é »ç‡é™åˆ¶
- âš ï¸  éœ€è¦çœŸå¯¦æ‰‹æ©Ÿæ¥æ”¶

---

## ğŸ”„ åè¦†æ¸¬è©¦çš„æ–¹æ³•

### å•é¡Œï¼šæ¸¬è©¦ä¸€æ¬¡å¾Œï¼Œå¦‚ä½•é‡æ–°æ¸¬è©¦ï¼Ÿ

**æƒ…æ³èªªæ˜ï¼š**
- **å·²é©—è­‰æˆåŠŸ**ï¼šæ‰‹æ©Ÿè™Ÿç¢¼å·²ç¶å®šåˆ°å¸³è™Ÿ â†’ éœ€è¦æ¸…é™¤ç¶å®šç‹€æ…‹æ‰èƒ½é‡æ–°æ¸¬è©¦
- **é©—è­‰å¤±æ•—**ï¼šé‚„æ²’æˆåŠŸç¶å®š â†’ å¯ä»¥ç›´æ¥é‡è©¦æˆ–é‡ç½®å˜—è©¦æ¬¡æ•¸

---

### æƒ…æ³ 1ï¼šå·²é©—è­‰æˆåŠŸï¼ˆç¶å®šæˆåŠŸï¼‰

#### æ–¹æ³• 1-1ï¼šè«‹åœ¨ Django Admin é‡ç½®

**è©³ç´°æ“ä½œæ­¥é©Ÿï¼š**

1. ç™»å…¥ Django Admin

2. æ‰¾åˆ° **Users** æˆ– **CustomUser**

3. æ‰¾åˆ°è©²çš„å¸³è™Ÿï¼Œé»æ“Šé€²å…¥ç·¨è¼¯

4. **æ¸…é™¤ä»¥ä¸‹æ¬„ä½**ï¼ˆé‡é»ï¼ï¼‰ï¼š
   ```
   âœ… phone_verified: â–¡ï¼ˆå–æ¶ˆå‹¾é¸ï¼Œæ”¹ç‚º Falseï¼‰
   âœ… phone_number: ï¼ˆå®Œå…¨æ¸…ç©ºï¼‰
   âœ… otp_attempts: 0ï¼ˆæ”¹ç‚º 0ï¼‰
   âœ… verification_status: ï¼ˆé¸æ“‡ã€Œ---------ã€æˆ–æ¸…ç©ºï¼‰
   âœ… last_otp_sent_at: ï¼ˆæ¸…ç©ºï¼Œå¦‚æœæœ‰çš„è©±ï¼‰
   ```

5. é»æ“Šã€Œå„²å­˜ã€

**å°±å¯ä»¥ç”¨åŒä¸€å€‹æ¸¬è©¦è™Ÿç¢¼é‡æ–°æ¸¬è©¦é©—è­‰æµç¨‹ã€‚**

---

#### æ–¹æ³• 1-2ï¼šä½¿ç”¨ä¸åŒçš„æ¸¬è©¦è™Ÿç¢¼

å¦‚æœè¨­å®šäº†å¤šå€‹æ¸¬è©¦è™Ÿç¢¼ï¼Œç›´æ¥æ›è™Ÿç¢¼æ¸¬è©¦ï¼š
- ç¬¬ 1 æ¬¡æ¸¬è©¦ç”¨ `+886987654321`
- ç¬¬ 2 æ¬¡æ¸¬è©¦ç”¨ `+886987654322`ï¼ˆä¸éœ€è¦é‡ç½®ï¼ï¼‰
- ç¬¬ 3 æ¬¡æ¸¬è©¦ç”¨ `+886987654323`ï¼ˆä¸éœ€è¦é‡ç½®ï¼ï¼‰

**æ¯å€‹è™Ÿç¢¼éƒ½æ˜¯ç¨ç«‹çš„ï¼Œä¸éœ€è¦é‡ç½®ï¼**

---

### æƒ…æ³ 2ï¼šé©—è­‰å¤±æ•—ï¼ˆé‚„æ²’æˆåŠŸç¶å®šï¼‰

#### æ–¹æ³• 2ï¼šä½¿ç”¨ä¸åŒçš„æ¸¬è©¦æ‰‹æ©Ÿè™Ÿç¢¼

åœ¨ Firebase Console åŠ å…¥å¤šå€‹æ¸¬è©¦è™Ÿç¢¼ï¼š

```
æ¸¬è©¦è™Ÿç¢¼ 1ï¼š+886987654321ï¼Œé©—è­‰ç¢¼ï¼š123456
æ¸¬è©¦è™Ÿç¢¼ 2ï¼š+886987654322ï¼Œé©—è­‰ç¢¼ï¼š123456
æ¸¬è©¦è™Ÿç¢¼ 3ï¼š+886987654323ï¼Œé©—è­‰ç¢¼ï¼š123456
```

æ¯æ¬¡æ¸¬è©¦ç”¨ä¸åŒè™Ÿç¢¼å³å¯ã€‚

---

## ğŸ› æ¸¬è©¦éŒ¯èª¤è¨Šæ¯çš„æ–¹æ³•

### æ¸¬è©¦ 1ï¼šå‰ç«¯ OTP éŒ¯èª¤

```javascript
try {
  // æ•…æ„è¼¸å…¥éŒ¯èª¤çš„ OTP
  await confirmationResult.confirm('000000');
} catch (error) {
  console.log('éŒ¯èª¤ä»£ç¢¼ï¼š', error.code);
  // é æœŸï¼š'auth/invalid-verification-code'
  
  console.log('éŒ¯èª¤è¨Šæ¯ï¼š', error.message);
  // é æœŸï¼š'The SMS verification code used to create the phone auth credential is invalid...'
}
```

---

### æ¸¬è©¦ 2ï¼šå¾Œç«¯ Token ç„¡æ•ˆ

```javascript
// æ•…æ„å‚³å‡çš„ idToken
const response = await fetch('/verify-otp/', {
  method: 'POST',
  body: JSON.stringify({
    verification_id: 'fake-invalid-token',
    otp_code: '123456'
  })
});

const data = await response.json();
console.log(data);
// é æœŸï¼š{ "error": "é©—è­‰ç¢¼å·²éæœŸæˆ–ç„¡æ•ˆï¼Œè«‹é‡æ–°ç™¼é€" }
```

---

### æ¸¬è©¦ 3ï¼šé€£çºŒéŒ¯èª¤ 3 æ¬¡è¢«é–å®š

```javascript
// ç¬¬ 1 æ¬¡éŒ¯èª¤
let response = await fetch('/verify-otp/', {
  body: JSON.stringify({
    verification_id: 'fake-token-1',
    otp_code: '111111'
  })
});
console.log(await response.json());
// é æœŸï¼š{ "status": "INVALID_OTP", "remaining_attempts": 2, ... }

// ç¬¬ 2 æ¬¡éŒ¯èª¤
response = await fetch('/verify-otp/', {
  body: JSON.stringify({
    verification_id: 'fake-token-2',
    otp_code: '222222'
  })
});
console.log(await response.json());
// é æœŸï¼š{ "status": "INVALID_OTP", "remaining_attempts": 1, ... }

// ç¬¬ 3 æ¬¡éŒ¯èª¤
response = await fetch('/verify-otp/', {
  body: JSON.stringify({
    verification_id: 'fake-token-3',
    otp_code: '333333'
  })
});
console.log(await response.json());
// é æœŸï¼š{ "status": "LOCKED", "retry_after": 60, ... }

// ç¬¬ 4 æ¬¡å˜—è©¦ï¼ˆå·²è¢«é–å®šï¼‰
response = await fetch('/verify-otp/', {
  body: JSON.stringify({
    verification_id: 'any-token',
    otp_code: '444444'
  })
});
console.log(await response.json());
// é æœŸï¼š{ "status": "LOCKED", "retry_after": 60, ... }
```

---

### æ¸¬è©¦ 4ï¼šRate Limitingï¼ˆ60 ç§’å…§é‡è¤‡ç™¼é€ï¼‰

```javascript
// ç¬¬ 1 æ¬¡ç™¼é€
await fetch('/send-otp/', {
  body: JSON.stringify({
    country_code: '+886',
    phone_number: '987654321'
  })
});
// é æœŸï¼šæˆåŠŸ

// ç«‹å³ç¬¬ 2 æ¬¡ç™¼é€
await fetch('/send-otp/', {
  body: JSON.stringify({
    country_code: '+886',
    phone_number: '987654321'
  })
});
// é æœŸï¼š{ "status": "TOO_MANY_REQUESTS", "retry_after": xx, ... }
```

---

### æ¸¬è©¦ 5ï¼šæ‰‹æ©Ÿè™Ÿç¢¼å·²è¢«å…¶ä»–ä½¿ç”¨è€…ç¶å®š

```javascript
// å‡è¨­ +886987654321 å·²è¢«ä½¿ç”¨è€… A ç¶å®š
// ä½¿ç”¨è€… B å˜—è©¦ç¶å®šåŒè™Ÿç¢¼

await fetch('/send-otp/', {
  body: JSON.stringify({
    country_code: '+886',
    phone_number: '987654321'  // å·²è¢«ç¶å®š
  })
});
// é æœŸï¼š{ "error": "PHONE_ALREADY_BOUND", "message": "æ­¤æ‰‹æ©Ÿè™Ÿç¢¼å·²è¢«å…¶ä»–å¸³è™Ÿç¶å®š" }
```

---

### æ¸¬è©¦ 6ï¼šæ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼éŒ¯èª¤

```javascript
// æ¸¬è©¦ï¼šç¼ºå°‘åœ‹ç¢¼
await fetch('/send-otp/', {
  body: JSON.stringify({
    country_code: '886',  // âŒ ç¼ºå°‘ +
    phone_number: '987654321'
  })
});
// é æœŸï¼š400 Bad Request

// æ¸¬è©¦ï¼šè™Ÿç¢¼å¤ªçŸ­
await fetch('/send-otp/', {
  body: JSON.stringify({
    country_code: '+886',
    phone_number: '123'  // âŒ å¤ªçŸ­
  })
});
// é æœŸï¼š400 Bad Request
```
